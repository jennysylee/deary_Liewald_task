<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deary-Liewald Reaction Time Task</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    #container {
      text-align: center;
      max-width: 900px;
      padding: 20px;
    }
    #canvas {
      border: 2px solid #333;
      background: white;
      margin: 20px auto;
    }
    #trial-counter {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin: 10px 0;
    }
    input[type="text"] {
      font-size: 24px;
      padding: 10px;
      width: 120px;
      text-align: center;
      margin: 10px;
    }
    button {
      font-size: 18px;
      padding: 12px 24px;
      margin: 10px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #instructions {
      font-size: 16px;
      margin: 20px 0;
      line-height: 1.4;
      min-height: 60px;
    }
    #results {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="trial-counter" style="display: none;">Trial <span id="trial-num">1</span>/<span id="trial-total">20</span></div>
    <canvas id="canvas" width="900" height="400"></canvas>
    
    <div id="participant-section" style="display: block;">
      <h1>Deary-Liewald Task</h1>
      <p>Enter your 3-digit participant number:</p>
      <input type="text" id="participant-id" maxlength="3" placeholder="001">
      <br>
      <button onclick="startExperiment()">Start Experiment</button>
    </div>

    <div id="instructions"></div>
    
    <div id="controls" style="display: none;">
      <button id="ready-btn" onclick="proceedFromInstruction()" disabled>I'm Ready - Start</button>
    </div>

    <div id="results" style="display: none;">
      <h2>Your Performance</h2>
      <div id="summary"></div>
      <button onclick="downloadCSV()">Download CSV Data</button>
      <button onclick="restartExperiment()">Restart Experiment</button>
    </div>
  </div>

  <script>
    // ==== Setup ====
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    const MAX_RESPONSE_TIME = 3000;
    const MIN_INTERVAL = 1000;
    const MAX_INTERVAL = 3000;

    // State
    let participantID = '';
    let currentBlock = '';
    let currentBlockIndex = -1;
    let trialIndex = 0;
    let blockTrialsRemaining = 0;
    let trials = [];
    let waitingForResponse = false;
    let startTime = 0;
    let timeoutTimer = null;
    let targetPosition = null;
    let correctPosition = null;
    let foreperiod = 0;
    let isPractice = false;
    let isShowingInstruction = true;  // NEW: track if we're on instruction screen

    const CHOICE_POSITIONS = [
      { x: -150, key: 'z', index: 1 },
      { x: -50,  key: 'x', index: 2 },
      { x: 50,   key: ',', index: 3 },
      { x: 150,  key: '.', index: 4 }
    ];

    const BLOCKS = [
      { name: 'practice_simple', type: 'simple', trials: 5, training: 1 },
      { name: 'simple_real', type: 'simple', trials: 20, training: 0 },
      { name: 'choice_real', type: 'choice', trials: 40, training: 0 }
    ];

    const INSTRUCTIONS = {
      practice_simple: "<strong>PRACTICE TRIALS (5 total)</strong><br><br>Press SPACE when the cross appears in the center box.<br><br>These practice trials do not count toward your score.",
      simple_real: "<strong>SIMPLE TASK (20 trials)</strong><br><br>Press SPACE when the cross appears in the center box.<br><br>Try to respond as quickly and accurately as possible.",
      choice_real: "<strong>CHOICE TASK (40 trials)</strong><br><br>Four boxes will appear. A cross will appear in one box.<br><br>Press the correct key:<br>Z (leftmost), X (left-center), COMMA (right-center), PERIOD (rightmost)<br><br>Try to respond as quickly and accurately as possible."
    };

    // ==== Drawing ====
    function updateTrialCounter() {
      document.getElementById('trial-num').textContent = trialIndex + 1;
      document.getElementById('trial-total').textContent = blockTrialsRemaining;
    }

    function clearCanvas() {
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, WIDTH, HEIGHT);
    }

    function drawBox(x, y = HEIGHT/2, filled = false) {
      const size = 80;
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 3;
      ctx.strokeRect(x - size/2, y - size/2, size, size);
      
      if (filled) {
        ctx.fillStyle = '#ff4444';
        ctx.font = '48px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('âœ•', x, y);
      }
    }

    function drawTrial(type) {
      clearCanvas();
      
      document.getElementById('trial-counter').style.display = 'block';
      updateTrialCounter();
      
      if (type === 'simple') {
        drawBox(WIDTH/2, HEIGHT/2, true);
      } else {
        CHOICE_POSITIONS.forEach(pos => drawBox(WIDTH/2 + pos.x, HEIGHT/2));
        const target = CHOICE_POSITIONS.find(p => p.index === targetPosition);
        drawBox(WIDTH/2 + target.x, HEIGHT/2, true);
      }
    }

    function drawFeedback(type) {
      clearCanvas();
      ctx.fillStyle = 'black';
      ctx.font = '36px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      
      if (type === 'wrong') {
        ctx.fillText('Wrong Key!', WIDTH/2, HEIGHT/2 - 50);
        ctx.font = '20px Arial';
        ctx.fillText('Z=1st, X=2nd, ,=3rd, .=4th', WIDTH/2, HEIGHT/2 + 50);
      } else if (type === 'slow') {
        ctx.fillText('Too Slow!', WIDTH/2, HEIGHT/2);
      }
    }

    // FIXED key handler
    document.addEventListener('keydown', function(e) {
      if (e.code === 'Space') e.preventDefault();

      // Don't respond during instruction screens
      if (isShowingInstruction || !waitingForResponse) return;

      let status = 'error';
      let rt = performance.now() - startTime;

      if (currentBlock.includes('simple')) {
        if (e.code === 'Space' || e.key === ' ') {
          status = 'correct';
        }
      } else {
        const pressedPos = CHOICE_POSITIONS.find(p => e.key === p.key);
        if (pressedPos && pressedPos.index === correctPosition) {
          status = 'correct';
        }
      }

      if (status !== 'error') {
        clearTimeout(timeoutTimer);
        recordTrial(status, rt);
      }
    });

    // ==== Experiment ====
    function startExperiment() {
      const idInput = document.getElementById('participant-id');
      participantID = idInput.value.trim();
      
      if (!/^\d{3}$/.test(participantID)) {
        alert('Enter 3-digit number (001)');
        return;
      }

      document.getElementById('participant-section').style.display = 'none';
      document.getElementById('controls').style.display = 'block';
      
      // Start with practice block 0
      currentBlockIndex = 0;
      showBlockInstruction();
    }

    function showBlockInstruction() {
      // NEW: Show instruction screen before each block
      isShowingInstruction = true;
      trialIndex = 0;
      document.getElementById('trial-counter').style.display = 'none';
      
      const blockObj = BLOCKS[currentBlockIndex];
      currentBlock = blockObj.name;
      blockTrialsRemaining = blockObj.trials;
      isPractice = blockObj.training;

      clearCanvas();
      document.getElementById('instructions').innerHTML = INSTRUCTIONS[currentBlock];
      document.getElementById('ready-btn').disabled = false;
      document.getElementById('ready-btn').textContent = 'I\'m Ready - Start';
    }

    function proceedFromInstruction() {
      // NEW: Called when user clicks "I'm Ready" button
      isShowingInstruction = false;
      document.getElementById('ready-btn').disabled = true;
      startTrial();
    }

    function startTrial() {
      if (trialIndex >= blockTrialsRemaining) {
        blockComplete();
        return;
      }

      foreperiod = MIN_INTERVAL + Math.random() * (MAX_INTERVAL - MIN_INTERVAL);
      
      clearCanvas();
      if (!currentBlock.includes('simple')) {
        CHOICE_POSITIONS.forEach(pos => drawBox(WIDTH/2 + pos.x, HEIGHT/2));
      }
      
      setTimeout(() => {
        if (currentBlock.includes('simple')) {
          targetPosition = 1;
          drawTrial('simple');
        } else {
          targetPosition = Math.floor(Math.random() * 4) + 1;
          correctPosition = targetPosition;
          drawTrial('choice');
        }
        
        startTime = performance.now();
        waitingForResponse = true;
        timeoutTimer = setTimeout(() => recordTrial('timeout'), MAX_RESPONSE_TIME);
      }, foreperiod);
    }

    function recordTrial(status, rt = null) {
      waitingForResponse = false;
      clearTimeout(timeoutTimer);

      const statusCode = { correct: 1, error: 2, timeout: 3 }[status];
      trials.push({
        participant_id: participantID,
        block: currentBlock,
        training: isPractice ? 1 : 0,
        num_choices: currentBlock.includes('simple') ? 1 : 4,
        foreperiod: Math.round(foreperiod),
        target_pos: targetPosition,
        rt: rt ? Math.round(rt) : null,
        status: statusCode
      });

      if (isPractice || currentBlock.includes('choice')) {
        // Feedback for practice and choice
        setTimeout(() => {
          if (status === 'timeout') {
            drawFeedback('slow');
            setTimeout(() => { trialIndex++; startTrial(); }, 1000);
          } else if (status === 'error') {
            drawFeedback('wrong');
            setTimeout(() => { trialIndex++; startTrial(); }, 2700);
          } else {
            trialIndex++;
            startTrial();
          }
        }, 100);
      } else {
        trialIndex++;
        setTimeout(startTrial, 500);
      }
    }

    function blockComplete() {
      // NEW: Move to next block with instruction screen
      currentBlockIndex++;
      
      if (currentBlockIndex >= BLOCKS.length) {
        // All blocks done
        showResults();
      } else {
        // Show instruction for next block
        showBlockInstruction();
      }
    }

    // Results (same)
    function showResults() {
      document.getElementById('controls').style.display = 'none';
      document.getElementById('results').style.display = 'block';
      document.getElementById('trial-counter').style.display = 'none';

      const realCorrectSimple = trials.filter(t => 
        t.training === 0 && t.num_choices === 1 && t.status === 1
      );
      const realCorrectChoice = trials.filter(t => 
        t.training === 0 && t.num_choices === 4 && t.status === 1
      );

      const simpleRT = realCorrectSimple.length ? 
        realCorrectSimple.reduce((sum, t) => sum + t.rt, 0) / realCorrectSimple.length : 0;
      const choiceRT = realCorrectChoice.length ? 
        realCorrectChoice.reduce((sum, t) => sum + t.rt, 0) / realCorrectChoice.length : 0;

      document.getElementById('summary').innerHTML = `
        <p><strong>ID:</strong> ${participantID}</p>
        <p>Correct trials (practice excluded):</p>
        <p><strong>Simple:</strong> ${simpleRT.toFixed(0)} ms (${realCorrectSimple.length} trials)</p>
        <p><strong>Choice:</strong> ${choiceRT.toFixed(0)} ms (${realCorrectChoice.length} trials)</p>
      `;
    }

    function downloadCSV() {
      const headers = ['participant_id','block','training','num_choices','foreperiod','target_pos','rt','status'];
      const csv = [headers.join(','), ...trials.map(t => 
        headers.map(h => `"${t[h]||''}"`).join(',')
      )].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `deary_liewald_${participantID}_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function restartExperiment() {
      trials = [];
      currentBlock = '';
      currentBlockIndex = -1;
      document.getElementById('results').style.display = 'none';
      document.getElementById('participant-section').style.display = 'block';
      document.getElementById('participant-id').value = participantID;
      document.getElementById('participant-id').focus();
    }

    document.getElementById('participant-id').addEventListener('keypress', e => {
      if (e.key === 'Enter') startExperiment();
    });
    document.getElementById('participant-id').focus();
  </script>
</body>
</html>
